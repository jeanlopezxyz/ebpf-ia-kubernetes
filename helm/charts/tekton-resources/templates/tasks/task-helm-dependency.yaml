apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: helm-dependency-update
  namespace: ebpf-security
  annotations:
    argocd.argoproj.io/sync-wave: "0"
  labels:
    app.kubernetes.io/name: tekton-ci
    app.kubernetes.io/instance: tekton-ci
    app.kubernetes.io/component: task-helm-dependency
    app.kubernetes.io/part-of: ebpf-ai-system
spec:
  description: Updates Helm chart dependencies and generates fresh .tgz files
  workspaces:
    - name: source
      description: Repository source code
  params:
    - name: chart-path
      description: Path to the Helm chart relative to workspace
      default: "."
  results:
    - name: dependencies-updated
      description: Whether dependencies were updated
  steps:
    - name: update-dependencies
      image: alpine/helm:latest
      workingDir: $(workspaces.source.path)
      script: |
        #!/bin/sh
        set -eu
        
        echo "ğŸ”§ Updating Helm chart dependencies..."
        
        CHART_PATH="$(params.chart-path)"
        UPDATED="false"
        
        # Find all Chart.yaml files
        find . -name "Chart.yaml" -path "*/helm/charts/*" | while read chart_file; do
          chart_dir=$(dirname "$chart_file")
          
          echo "ğŸ“Š Processing chart: $chart_dir"
          
          # Check if chart has dependencies
          if grep -q "dependencies:" "$chart_file"; then
            echo "  â”œâ”€â”€ Found dependencies in $chart_file"
            
            cd "$chart_dir"
            
            # Check if Chart.lock exists and is newer than Chart.yaml
            if [ -f Chart.lock ] && [ Chart.lock -nt Chart.yaml ]; then
              echo "  â”œâ”€â”€ Dependencies up to date"
            else
              echo "  â”œâ”€â”€ Updating dependencies..."
              
              # Update dependencies
              helm dependency update
              
              if [ $? -eq 0 ]; then
                echo "  â”œâ”€â”€ âœ… Dependencies updated successfully"
                UPDATED="true"
              else
                echo "  â”œâ”€â”€ âŒ Failed to update dependencies"
                exit 1
              fi
            fi
            
            cd - > /dev/null
          else
            echo "  â”œâ”€â”€ No dependencies found"
          fi
        done
        
        # Return result
        printf "%s" "$UPDATED" > $(results.dependencies-updated.path)
        
        if [ "$UPDATED" = "true" ]; then
          echo "âœ… Helm dependencies updated successfully"
        else
          echo "â„¹ï¸  No dependency updates needed"
        fi