{{- if .Values.prometheus.enabled }}
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: ebpf-ai-alerts
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: prometheus
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/component: rules
    app.kubernetes.io/part-of: ebpf-ai
spec:
  groups:
  - name: ebpf-ai.threat-detection
    rules:
    # Critical threat alerts
    - alert: CriticalThreatDetected
      expr: increase(ml_detector_threats_total{confidence_level="high"}[1m]) > 0
      for: 0s
      labels:
        severity: critical
        component: ml-detector
        alert_type: security_threat
      annotations:
        summary: "🚨 Critical threat detected"
        description: "High confidence threat detected: {{`{{ $labels.threat_type }}`}} from {{`{{ $labels.source_ip }}`}}"
        
    - alert: PortScanDetected
      expr: increase(ml_detector_port_scan_total[2m]) > 0
      for: 0s
      labels:
        severity: warning
        component: ml-detector
        alert_type: port_scan
      annotations:
        summary: "🔍 Port scanning activity detected"
        description: "Port scan detected with severity: {{`{{ $labels.severity }}`}}"
        
    - alert: DDoSAttackDetected
      expr: increase(ml_detector_ddos_total[1m]) > 0
      for: 0s
      labels:
        severity: critical
        component: ml-detector
        alert_type: ddos
      annotations:
        summary: "💥 DDoS attack detected"
        description: "DDoS attack detected: {{`{{ $labels.attack_type }}`}}"
        
    - alert: DataExfiltrationDetected
      expr: increase(ml_detector_data_exfiltration_total[5m]) > 0
      for: 0s
      labels:
        severity: critical
        component: ml-detector
        alert_type: data_exfiltration
      annotations:
        summary: "📤 Data exfiltration detected"
        description: "Potential data exfiltration: {{`{{ $labels.direction }}`}} direction"

  - name: ebpf-ai.system-health
    rules:
    # System health alerts
    - alert: MLDetectorHighAnomalyRate
      expr: rate(ml_detector_anomaly_total[5m]) > 10
      for: 2m
      labels:
        severity: warning
        service: ml-detector
      annotations:
        summary: "High anomaly detection rate"
        description: "ML Detector is detecting anomalies per second for more than 2 minutes"
        
    - alert: MLDetectorDown
      expr: up{job="ml-detector"} == 0
      for: 1m
      labels:
        severity: critical
        service: ml-detector
      annotations:
        summary: "ML Detector service is down"
        description: "ML Detector has been down for more than 1 minute"
        
    - alert: MLDetectorHighMemoryUsage
      expr: container_memory_usage_bytes{name=~".*ml-detector.*"} / container_spec_memory_limit_bytes > 0.9
      for: 5m
      labels:
        severity: warning
        service: ml-detector
      annotations:
        summary: "High memory usage in ML Detector"
        description: "ML Detector memory usage is above 90% for more than 5 minutes"
        
    # eBPF Monitor Alerts
    - alert: EBPFMonitorDown
      expr: up{job="ebpf-monitor"} == 0
      for: 1m
      labels:
        severity: critical
        service: ebpf-monitor
      annotations:
        summary: "eBPF Monitor service is down"
        description: "eBPF Monitor has been down for more than 1 minute"
        
    - alert: LowNetworkEventRate
      expr: rate(network_events_total[5m]) < 1
      for: 5m
      labels:
        severity: warning
        service: ebpf-monitor
      annotations:
        summary: "Low network event rate"
        description: "eBPF Monitor is collecting fewer than 1 event per second for more than 5 minutes"
        
    # General System Alerts
    - alert: PodCrashLooping
      expr: rate(kube_pod_container_status_restarts_total{namespace="ebpf-security"}[5m]) > 0
      for: 5m
      labels:
        severity: warning
        service: kubernetes
      annotations:
        summary: "Pod is crash looping"
        description: "Pod is restarting frequently in ebpf-security namespace"
        
    - alert: PodNotReady
      expr: kube_pod_status_ready{condition="false", namespace="ebpf-security"} == 1
      for: 10m
      labels:
        severity: warning
        service: kubernetes
      annotations:
        summary: "Pod not ready"
        description: "Pod has been not ready for more than 10 minutes in ebpf-security namespace"
{{- end }}
