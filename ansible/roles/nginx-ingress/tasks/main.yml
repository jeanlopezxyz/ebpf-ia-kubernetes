---
- name: Add NGINX Ingress Helm repository
  kubernetes.core.helm_repository:
    name: ingress-nginx
    repo_url: https://kubernetes.github.io/ingress-nginx

- name: Set NGINX Ingress values for external LB
  ansible.builtin.set_fact:
    nginx_values:
      controller:
        service:
          type: NodePort
          nodePorts:
            http: 30080
            https: 30443
          externalTrafficPolicy: Local
        ingressClassResource:
          default: true
        metrics:
          enabled: true
        podAnnotations:
          prometheus.io/scrape: "true"
          prometheus.io/port: "10254"
  when: deployment_mode.external_lb | default(false)

- name: Set NGINX Ingress values for LoadBalancer
  ansible.builtin.set_fact:
    nginx_values:
      controller:
        service:
          type: LoadBalancer
          loadBalancerIP: "{{ network.nginx_ingress_ip }}"
          externalTrafficPolicy: Local
        ingressClassResource:
          default: true
        metrics:
          enabled: true
        podAnnotations:
          prometheus.io/scrape: "true"
          prometheus.io/port: "10254"
  when: not (deployment_mode.external_lb | default(false))

- name: Install NGINX Ingress Controller via Helm
  kubernetes.core.helm:
    name: ingress-nginx
    chart_ref: ingress-nginx/ingress-nginx
    chart_version: "4.11.3"
    release_namespace: ingress-nginx
    create_namespace: true
    values: "{{ nginx_values }}"
    wait: true
    timeout: 300s

- name: Wait for NGINX Ingress to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: ingress-nginx-controller
    namespace: ingress-nginx
    wait: true
    wait_condition:
      type: Available
      status: "True"
    wait_timeout: 300
    
- name: Display NGINX Ingress status (External LB)
  ansible.builtin.debug:
    msg:
      - "âœ… NGINX Ingress Controller installed successfully!"
      - "ğŸ”— Service Type: NodePort (External LB mode)"
      - "ğŸŒ External access via pfSense load balancer"
      - "ğŸ“¦ Namespace: ingress-nginx"
      - "ğŸ”§ Metrics: Enabled on port 10254"
  when: deployment_mode.external_lb | default(false)

- name: Display NGINX Ingress status (LoadBalancer)
  ansible.builtin.debug:
    msg:
      - "âœ… NGINX Ingress Controller installed successfully!"
      - "ğŸŒ LoadBalancer IP: {{ network.nginx_ingress_ip }}"
      - "ğŸ“¦ Namespace: ingress-nginx"
      - "ğŸ”§ Metrics: Enabled on port 10254"
  when: not (deployment_mode.external_lb | default(false))